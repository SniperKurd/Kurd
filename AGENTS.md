# AGENTS — تشغيل، إصلاح، وتنظيم المشروع (Static/JS + PHP)

> هذا الملف يوجّه Codex لتشغيل مشروعك سحابيًا، إصلاح الأعطال الأساسية، وتنظيم الكود بأسلوب feature-based، ثم التقدّم عبر سباقات (Sprints) بفروع وطلبات دمج (PRs). ضعه في **جذر المستودع**.

## قواعد عامة للوكيل (Codex)
- لا تعدّل ملفات حسّاسة دون نسخة احتياطية بامتداد `.bak`.
- احترم المنفذ من متغيّر البيئة `PORT` واستمع على `0.0.0.0` دائمًا.
- اطبع دائمًا **رابط المعاينة** + **ملخص ما حدث** + **أي أخطاء**.
- كل دفعة تغييرات → على **فرع** جديد + **PR** مع قائمة مراجعة (Checklist).
- لا تُخزّن أسرارًا في المستودع؛ استخدم متغيّرات البيئة/`.env`.

---

## بيئة التشغيل والمتغيّرات
أنشئ/حدّث `.env.example` ثم انسخ إلى `.env` عند التشغيل:
```
ADMIN_TOKEN=        # رمز لحماية الحفظ/الرفع في PHP (اختياري لكنه موصى به)
BASE_PATH=          # مسار أساسي إن استُضيفت الصفحات تحت مجلد فرعي (افتراضي فارغ "")
RPC_URL_PRIMARY=    # RPC أساسي (https)
RPC_URL_FALLBACK=   # RPC بديل (https)
```
- اقرأ هذه القيم من البيئة في سكربتات/نقاط نهاية PHP والواجهة.

---

## التشغيل السحابي (Auto-Detect Runtime)
1) **استكشاف المشروع**
   - اطبع شجرة الملفات: `ls -R`.
   - تعرّف التقنية:
     - وجود `*.php` ⇒ تشغيل **PHP built-in server**.
     - وجود `package.json` ⇒ نمط Static/Node لأدوات مساعدة (اختبارات/سيرفر ملفات).
     - إن وُجدا معًا: الصفحات عبر PHP، والاختبارات/الأدوات عبر Node.

2) **التشغيل**
   - **PHP** (الأولوية إن وُجد):  
     ```bash
     php -S 0.0.0.0:${PORT:-8080} -t .
     ```
   - **Static/Node** (إن لم يوجد PHP):  
     - إن لم يوجد `scripts.start` فأنشئه باستخدام http-server:
       ```json
       { "scripts": {
         "setup": "npm ci || npm install",
         "dev": "http-server -a 0.0.0.0 -p ${PORT:-5173} -c-1 .",
         "start":"http-server -a 0.0.0.0 -p ${PORT:-8080} -c-1 .",
         "test":"echo \"(no tests)\""
       }}
       ```
     - ثم: `npm run setup && npm run start`
   - اطبع رابط المعاينة وأبقِ العملية قيد التشغيل.

3) **تشخيص سريع**
   - افتح `index.html` و`admin.html` من رابط المعاينة.
   - اطبع أخطاء الكونسول وطلبات 404/500.
   - أصلح فورًا مسارات الأصول (اجعلها نسبية: `assets/...` بدل `/assets/...`).

---

## Sprint 0 — تشغيل + تقسية أساسية
**الهدف:** تشغيل مستقر + حماية نقاط النهاية + إصلاح مسارات/روابط.

- **حماية PHP** (`config/save-config.php`, `config/upload-image.php`, وأي نقاط كتابة):
  1) استخدم رأس `Authorization: Bearer <ADMIN_TOKEN>`
  2) اقرأ `ADMIN_TOKEN` من البيئة؛ إن غاب/اختلف ⇒ HTTP **401** مع رسالة عربية واضحة.
- **رفع الصور** في `upload-image.php`:
  1) اسمح فقط بالامتدادات: `png,jpg,jpeg,webp,svg` وتحقق من MIME.
  2) حد الحجم ≤ **2MB**، واسم ملف عشوائي آمن داخل `config/uploads`.
  3) أعد **URL نسبيًا** يعتمد `BASE_PATH` (افتراضي فارغ `""`).
- **المسارات**:
  - أي رابط يبدأ `/…` اجعله نسبيًا `…` ليتوافق مع معاينة السحابة.
- **توثيق التشغيل**:
  - حدّث/أنشئ `README.md` يشرح: تشغيل PHP، المتغيّرات، وعناوين المعاينة.
- **نتيجة مطلوبة**: افتح PR `feature/sprint-0` بعنوان **“Run & Hardening”** مع:
  - رابط المعاينة، ملخص التغييرات، لقطات من السجلات، وقائمة مراجعة:
    - [ ] يعمل سحابيًا
    - [ ] حماية Bearer للكتابة/الرفع
    - [ ] إصلاح مسارات الأصول
    - [ ] README محدّث

---

## Sprint 1 — تنظيم الكود (Feature-Based + ES Modules)
**الهدف:** فصل المنطق إلى وحدات نظيفة قابلة للتوسّع.

- أنشئ الهيكل التالي وانقل المنطق من `assets/js/app.js`, `assets/js/admin.js`, `assets/js/revert-diagnoser.js`:
  ```
  src/modules/
    core/      dom.js, utils.js, format.js
    admin/     ui.js, api.js           # لـ admin.html
    swap/      router.js, pricing.js, slippage.js
    diagnoser/ revert.js
  ```
- اجعل سكربتات الصفحات `type="module"` واستورد من `src/modules`.
- اكتب تعليقًا أعلى كل ملف يصف مسؤوليته.
- **PR**: `feature/sprint-1` — “Modularization (ESM)”
  - Checklist: [ ] لا كسر للوظيفة  [ ] وحدات مستقلة  [ ] إزالة التكرار

---

## Sprint 2 — تحسين لوحة التحكّم (admin.html)
**الهدف:** إدخال بيانات سليمة وتجربة مريحة.

- التحقق من عناوين العقود/العملات بواسطة `ethers` (Normalize + checksum).
- **زر اختبار الاتصال** يقرأ `blockNumber` من `RPC_URL_PRIMARY` ويعرض النتيجة.
- الحفظ إلى الخادم:
  - أرسل `Authorization: Bearer <ADMIN_TOKEN>`
  - رسائل نجاح/فشل عربية بسيطة + لوحة Debug للتفاصيل عند الطلب.
- **PR**: `feature/sprint-2` — “Admin UX + Validation”
  - Checklist: [ ] تحقق عناوين  [ ] حفظ آمن  [ ] إشعارات واضحة

---

## Sprint 3 — منطق المقايضة/التنفيذ (إن وُجد)
**الهدف:** تنفيذ أكثر موثوقية وتشخيص أعطال قابل للفهم.

- حساب **slippage** و**minReceived** وتحذير تأثير سعري عالٍ.
- **Revert diagnoser**:
  - جرّب `estimateGas` قبل التنفيذ، وإن فشل أعطِ تلميحات (مثل نقص السماح/faulty pair).
- مهلة RPC + التبديل تلقائيًا إلى `RPC_URL_FALLBACK`.
- رسائل أخطاء موجزة للمستخدم، ومفصّلة في Debug.
- **PR**: `feature/sprint-3` — “Swap Reliability & Diagnostics”
  - Checklist: [ ] حسابات سليمة  [ ] تشخيص دقيق  [ ] تعافٍ من فشل RPC

---

## Sprint 4 — اختبارات واجهة خفيفة (اختياري)
- أضف Playwright محليًا فقط:
  ```json
  { "scripts": { "test": "playwright test" }, "devDependencies": { "playwright": "*" } }
  ```
- سيناريوهات: فتح الصفحة الرئيسية، وجود العناصر الأساسية، سيناريو إدخال زوج/انزلاق (RPC مُحاكًى).
- **PR**: `feature/sprint-4` — “UI Tests”

---

## مخرجات مطلوبة بعد كل Sprint
- رابط المعاينة الخارجي.
- ملخص واضح: ماذا تغيّر ولماذا.
- قائمة الملفات المضافة/المعدلة (Diff مختصر).
- لقطات شاشة/ناتج أوامر يثبت التحقق (إن أمكن).
- رابط الـPR.

---

## استكشاف أخطاء شائعة
- **لا يظهر رابط المعاينة**: تأكد من الاستماع `0.0.0.0` واحترام `PORT`.
- **صور/CSS لا تُحمّل**: أصلح المسارات واجعلها نسبية.
- **401 عند الحفظ/الرفع**: وفّر `ADMIN_TOKEN` في البيئة/`.env`.
- **CORS/Mixed Content**: استخدم RPC عبر https فقط.

---

## قائمة تحقق سريعة قبل طلب الدمج
- [ ] تشغيل سحابي مستقر.
- [ ] توثيق README محدّث.
- [ ] لا أسرار داخل الريبو.
- [ ] PR واضح مع Checklist ورابط المعاينة.
